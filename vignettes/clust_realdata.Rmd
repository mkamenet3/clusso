---
title: "Running *clust* with Real Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to clust}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

#Introduction

Load *clust*

```{r, message=FALSE, warning=FALSE}
library("clust")

```


## Running the _clust_ with real data

### Prepare Data


```{r}
set.seed(8282017)

#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]

```

### Set global conditions

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE

```


### Running the models

```{r}

clst <- toclust(japanbreastcancer, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death,timeperiod = japanbreastcancer$period, covars = FALSE)

system.time(resreal <- clust(clst, x,y, rMax, Time, utm=TRUE, byrow=TRUE, space="both", overdispfloor=TRUE, cv=NULL))

```

### Maps

Save diagnostics into csv:

```{r}
#save results
#filename <- paste0("jbc_analysis_5_7_18",".RData")
filename <- paste0("jbc_analysis_7_11_18",".RData")
save(resreal, file = filename)


#Create Empty PDF to Map Onto
#pdfname <- paste0("jbc_analysis_5_7_18",".pdf")
pdfname <- paste0("jbc_analysis_7_16_18",".pdf")
easyplot(japan.prefect2, japan.poly2 ,pdfname, resreal$rrcolors, mods, space="both", probmap=FALSE, obs=TRUE,rr=TRUE)

#BIC map
#pdfname <- paste0("jbc_analysisBIC_5_7_18",".pdf")
pdfname <- paste0("jbc_analysisBIC_7_16_18",".pdf")
easyplot(japan.prefect2, japan.poly2 ,pdfname, resreal, mods, space="BIC", probmap=FALSE,rr=TRUE)


```


### Diagnostics of Clusters Detected

```{r}

model <- c(rep("Poisson",2), rep("Quasi-Poisson",2))
st <- rep(c("Space", "Space-Time"),2)
numclust.AIC <- c(res$lassoresult.p.s$numclust.qaic, res$lassoresult.p.st$numclust.qaic, 
                  res$lassoresult.qp.s$numclust.qaic, res$lassoresult.qp.st$numclust.qaic)
numclust.AICc <- c(res$lassoresult.p.s$numclust.qaicc, res$lassoresult.p.st$numclust.qaicc, 
                   res$lassoresult.qp.s$numclust.qaicc, res$lassoresult.qp.st$numclust.qaicc)
numclust.BIC <- c(res$lassoresult.p.s$numclust.qbic, res$lassoresult.p.st$numclust.qbic, 
                  res$lassoresult.qp.s$numclust.qbic, res$lassoresult.qp.st$numclust.qbic)

(table.clusters <- cbind(model, st, numclust.AIC, numclust.AICc, numclust.BIC))


#WRITE TO CSV
print(table.clusters)
write.csv(table.clusters, file="tableclusters_codechange_4_16_18.csv", row.names=TRUE)

```




## Comparison to Cross-Validation


```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]

```


```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
cv <- 10 #how many folds
clst <- toclust(japanbreastcancer, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death,timeperiod = japanbreastcancer$period, covars = FALSE)

system.time(res <- clust::clust(clst,x,y, rMax, Time, utm=TRUE, byrow=TRUE, space="both", overdispfloor=TRUE, cv))


```

```{r}

model <- c(rep("Poisson",2), rep("Quasi-Poisson",2))
st <- rep(c("Space", "Space-Time"),2)
numclust.cv <- c(res$lassoresult.p.s$numclust.cv, res$lassoresult.p.st$numclust.cv, 
                  res$lassoresult.qp.s$numclust.cv, res$lassoresult.qp.st$numclust.cv)


(table.clusterscv <- cbind(model, st, numclust.cv))


#WRITE TO CSV
print(table.clusterscv)
write.csv(table.clusterscv, file="tableclusters_cv.csv", row.names=TRUE)
```

### Maps

```{r}
#save results
filename <- paste0("jbc_analysis_cv",".RData")
save(res, file = filename)


#Create Empty PDF to Map Onto
pdfname <- paste0("jbc_analysis_cv",".pdf")

easyplot(japan.prefect2, japan.poly2 ,pdfname, res$rrcolors, mods, space="both", probmap=FALSE, cv=10, obs=TRUE, rr=TRUE)

```


## Real Data Example with Covariates

Import geography data:

```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]


```


```{r}
#Set-up
head(japanbreastcancer)
head(utmJapan)

#add a couple of covariates to the dataframe
covar1 <- rnorm(n = nrow(dframe),mean = 500, sd = 30)
covar2 <- rpois(n = nrow(dframe), lambda = japanbreastcancer$expdeath)
covar3 <- rbinom(n = nrow(dframe), size = 50, prob = 0.7)
covar4 <- rbinom(n = nrow(dframe), 1, 0.5)
covar5 <- rbinom(n = nrow(dframe), 1, 0.2)

#add new covariates to dataframe
df <- cbind.data.frame(japanbreastcancer[,-1], covar1, covar2, covar3, covar4, covar5)

#check out the new dataframe
head(df)

#assume this is what you start with
```


```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
cv <- 10 #how many folds
clst <- toclust(df, expected = df$expdeath, observed = df$death, timeperiod = df$period, covars=TRUE)

system.time(res <- clust(clst, x,y, rMax, Time, utm=TRUE, byrow=TRUE, space="both", overdispfloor, cv))

```

### Maps


```{r}
#save results
filename <- paste0("jbc_analysis_covars",".RData")
save(res, file = filename)


#Create Empty PDF to Map Onto
pdfname <- paste0("jbc_analysis_covars",".pdf")

easyplot(japan.prefect2, japan.poly2 ,pdfname, res$rrcolors, mods, space="both", obs=TRUE, obs=TRUE, obs=TRUE,rr=TRUE)
```

