---
title: "Running *clust* with Simulations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to clust}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


#Introduction

Load *clust*

```{r, message=FALSE, warning=FALSE}
library("clust")
```


## Running the Null Model (no cluster to detect)

### Prepare Data


```{r}
set.seed(8202017)

dframe1 <- read.csv("../data/jap.breast.F.9.10.11.csv")
dframe2 <- read.csv("../data/utmJapan.csv")
dframe3 <- aggregate(dframe1, by=list(as.factor(rep(1:(nrow(dframe1)/4),each=4))), FUN="sum")
dframe=data.frame(id=as.factor(dframe3$id/4),period=as.factor(dframe3$year),death=dframe3$death,expdeath=dframe3$expdeath)
levels(dframe$period) <- c("1","2","3","4","5")

dframe.poly2 <- read.csv("../data/japan_poly2.csv")
japan.poly2 <- dframe.poly2[,2:3]
dframe.prefect2 <- read.csv("../data/japan_prefect2.csv")
japan.prefect2 <- dframe.prefect2[,2:5]

head(dframe)
head(dframe.poly2)
head(dframe.prefect2)
```



### Set global conditions


Set threshold(s):

```{r}
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")
```

Set the easting and northing coordinates:

```{r}
x=dframe2$utmx/1000
y=dframe2$utmy/1000

```

Set other conditions. Right now, the null model requires to still input a center and radius even for the null case, but this will be adjusted in future versions.

```{r}
rMax=20
Time=5
nsim=2 #number of simulations

#need inputs for model to run
center=1
radius=18
timeperiod = c(1:5)
risk=1
theta = NULL
floor = TRUE

table.detection.null <- NULL

```


### Running the models


Run the null model and store results into object $res$.

```{r}
system.time(res <- clust_sim(x,y,rMax,dframe$period, dframe$expdeath, dframe$death, Time,
                                 nsim,center, radius, risk, timeperiod,
                                 utm=TRUE, byrow=TRUE, threshold, space= "both",
                             theta = theta, nullmod = TRUE, floor))
```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk), "NULL"))
filename <- paste0("sampleoutput/",sim.i,".RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))
table.detection.null <- rbind(table.detection.null, tabn)


#WRITE TO CSV
print(table.detection.null)
write.csv(table.detection.null, file="sampleoutpuet/tabledetectionNULL.csv", row.names=TRUE)


```


Make maps!

```{r}
#make maps
pdfname <- paste0("sampleoutput/sim","_","center","_",center,"radius",radius,"_", "start",
                  "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio),"NULL.pdf")
easyplot(pdfname, res, mods, space="both")
```




## Running Cluster Model with Multiple Simulated Clusters

We use the same dataset as before

Set initial conditions:

```{r}
#Set Some Initial Conditions
x=dframe2$utmx/1000
y=dframe2$utmy/1000
rMax=20
Time=5
#nsim=100
nsim=2 #change number of simulations


centers <- c(150, 35)
radii <- c(9, 11, 18)
timeperiods <- list(c(3:5), c(1:2), c(2:4))
risk.ratios <- c(1.1, 1.5, 2)
nullmod = NULL
theta = 2 #with overdispersion. For no overdispersion, set theta = NULL
floor = TRUE

table.detection <- NULL
```



Run multiple models:

```{r}
for(cent in centers){
    for(rad in radii){
        for(tim in timeperiods){
            for(risk in risk.ratios){
                print(c(cent, rad, tim, risk))
                system.time(res <- clust_sim(x,y,rMax,dframe$period, dframe$expdeath, dframe$death, Time,
                                     nsim,cent, rad, risk, tim, utm=TRUE, byrow=TRUE, threshold, 
                                     space= "both", theta, nullmod, floor))
                #save results
                (sim.i <- paste0("sim","_","center","_",cent,"radius",rad,"_", "start",
                                 "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk)))
                filename <- paste0("sampleoutput/",sim.i,".RData")
                save(res, file = filename)

                #Print Detection for the Simulation
                (tabn <- rbind("******",cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "ST",
                                               rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
                                cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "Space",
                                      rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))
                table.detection <- rbind(table.detection, tabn)

                #Print Descriptives

                #make maps
                pdfname <- paste0("sampleoutput/sim","_","center","_",cent,"radius",rad,"_", "start",
                                  "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),".pdf")
                easyplot(pdfname, res, mods, space="both")

            }
        }
    }
}

```

Write output to csv:

```{r}

#WRITE TO CSV
print(table.detection)
write.csv(table.detection, file="sampleoutput/tabledetectionclustersim.csv", row.names=TRUE)

#Print Table Detection
table.detection
print(table.detection)

```




## Running simulation with covariates

Import geography data:

```{r}

dframe.poly2 <- read.csv("../data/japan_poly2.csv")
japan.poly2 <- dframe.poly2[,2:3]
dframe.prefect2 <- read.csv("../data/japan_prefect2.csv")
japan.prefect2 <- dframe.prefect2[,2:5]

head(dframe.poly2)
head(dframe.prefect2)


```



Import dataframe with covariates:

```{r}
#Set-up
dframe1 <- read.csv("../data/jap.breast.F.9.10.11.csv")
dframe2 <- read.csv("../data/utmJapan.csv")
dframe3 <- aggregate(dframe1, by=list(as.factor(rep(1:(nrow(dframe1)/4),each=4))), FUN="sum")
dframe=data.frame(id=as.factor(dframe3$id/4),period=as.factor(dframe3$year),death=dframe3$death,expdeath=dframe3$expdeath)
levels(dframe$period) <- c("1","2","3","4","5")

#add a couple of covariates to the dataframe
covar1 <- rnorm(n = nrow(dframe),mean = 500, sd = 30)
covar2 <- rpois(n = nrow(dframe), lambda = dframe$expdeath)
covar3 <- rbinom(n = nrow(dframe), size = 50, prob = 0.7)
covar4 <- rbinom(n = nrow(dframe), 1, 0.5)
covar5 <- rbinom(n = nrow(dframe), 1, 0.2)

#add new covariates to dataframe
df <- cbind.data.frame(dframe[,-1], covar1, covar2, covar3, covar4, covar5)

#check out the new dataframe
head(df)

#assume this is what you start with
```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- dframe2$utmx/1000
y <- dframe2$utmy/1000
rMax <- 20 
Time <- 5
floor <- TRUE
nsim <- 2

```

### Set conditions for cluster

```{r}
center <- 75 #can take values 1 - 208 because we have a total of 208 centroids
radius <- 11
timeperiods <- c(3:5)
risk.ratio <- 1.5
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- 2 #with overdispersion. For no overdispersion, set theta = NULL
floor <- TRUE

table.detection <- NULL

```



```{r}

clst <- toclust(df, expected = df$expdeath, observed = df$death, timeperiod = df$period, covars=TRUE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,centers, radius, risk.ratios, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, floor))

```



