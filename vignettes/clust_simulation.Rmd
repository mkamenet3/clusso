---
title: "Running *clust* with Simulations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to clust}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


#Introduction

This package is still under development. Please [report any bugs](https://github.com/mkamenet3/cluST/issues).


Load `clust`package:

```{r, message=FALSE, warning=FALSE}
#load package
library("clust")

#load dev version R scripts
file.sources = list.files("../R/",pattern="*.R")
sapply(paste0("../R/",file.sources),source,.GlobalEnv)
load("../data/japanbreastcancer.RData")
```


## Toy Example 1: Simulation

In this first simulation, we will explore how to use the `clust` package to perform a simple simulation using the Japanese breast cancer data set. For simplicity, no covariates are included and `nsim=10` for speed and illustration.

### Prepare Data

We start by setting the seed using the `set.seed()` to ensure that the simulation is reproducible. We load the data that comes with the `clust` package with `data("japanbreastcancer")`.

```{r}
set.seed(8202017)
#load data
data("japanbreastcancer")
```

To explore the 4 data sets that are part of `japanbreastcancer`, we apply the `head()` function to each of the data sets.
1. `utmJapan`: data set containing a unique identifier for each centroid (*id*), x-coordinate in UTM (*utmx*), and y-coordinate in UTM (*utmy*)
1. `dframe.poly2`: polygon tesselations
1. `dframe.prefect2`: boundaries for the prefects (geographical boundaries) of the region.
1. `japanbreastcancer`: data set containting a unique identifier for each centroid (*id*), period of observation (categorical variable with 5 levels, *period*), death count (*death*), expected death count (*expdeath)

```{r}
#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

```

From the polygons (`dframe.poly2`) data set we extract the second and third columns, only the x and y coordinates of the polygons and create `japan.poly2`. From the prefect boundaries (`dframe.prefect2`) data set, we extract the second through fifth columns - the two x and two y coordinates of the polygons boundaries and create `japan.prefect2`.

```{r}
#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]
```

### Set global conditions

When using `clust`, there are certain global parameters that need to be set


We first set a threshold for detection (**TODO: MAKE THIS OPTIONAL AND NOT REQUIRE 2**)

```{r}
threshold <- c(0.9, 0.5)
```

There are two types of models we want to run: a quasi-poisson and Poisson model. Specifying this argument will make the output nicer (**TODO: CHANGE THIS TO OPTIONAL, CREATE REASONABLE DEFAULTS**)

```{r}
mods <- c("QuasiPoisson", "Poisson")
```

We take the easting and northing coordinates from the `utmJapan` dataset, set the easting coordinate, `utmx`, to `x` and the northing coordinate, `utmy`, to `y`. Each is divided by 1000 to change the scale from meters to kilometers.

```{r}
x=utmJapan$utmx/1000
y=utmJapan$utmy/1000

```

Below, we set the maximum radius for a cluster to 20 km (`rMax=20`) based on scientific knowledge of the area and our definition of a meaningful cluster, set the number of unique time periods to 5 (`Time=5`), number of simulations to be run to 10 (`nsim=10`), and set a floor for overdispersion to avoid estimating underdispersion (`overdispfloor=TRUE`). 

Since this is a simulation, we must first create a cluster to be found using `clust`. We create a cluster centered at centroid #1 (`center=1`), with a radius of 18km (`radius=18`), that exists in all 5 time periods (`timeperiod=c(1:5)`), has a risk.ratio of 2 (`risk.ratio=2`), moderate overdispersion (`theta=1000`).

 For poisson model with no overdispersion, set ```theta=Inf```.

```{r}
rMax=20
Time=5
#nsim=100 #number of simulations
nsim = 10
overdispfloor = TRUE

#create cluster to detect
center=150
radius=18
timeperiod = c(1:5)
risk.ratio=2
theta = 1000
#theta = Inf #if theta=Inf, this will run the pure Poisson model with no overdispersion at all.
```

Lastly, for simulation output, we create two objects to hold the output.

```{r}
nullmod <- NULL
table.detection.null <- NULL

```


### Running the models

If we apply the `head()` function to the `japanbreastcancer` data set, we find that the first column is `id` and is an identifier for each centroid. We omit this column below and only keep the time period (`period`), observed (`death`) and expected (`expdeath`) counts. **TODO: Have this automated so user doesn't need to worry about it.**

```{r}
japanbreastcancer<- japanbreastcancer[,-1] #get rid of id column to use clst function
head(japanbreastcancer)
```

The first step is to create a `clst` object using the `toclust()` function. By applying `str()` to `clst`, we see that the `clst` object neatly organizes the data into required covariates (expected counts, observed counts, and timeperiod are required), and other covariates (omitted here). If you have additional covariates, additional covariates will be included in the model and will not be penalized under the LASSO.

```{r}
#create clst class object
clst <- toclust(japanbreastcancer, expected = expdeath, observed = death, timeperiod = period)
class(clst)
str(clst)
```

Finally, we are ready to perform the simulation using the `clust_sim()` function.

```{r}
#run clust_sim and time it
system.time(res <- clust_sim(clst, x,y,rMax, Time,
                                 nsim,center, radius, risk.ratio, timeperiod,utm = TRUE,
                                 threshold, analysis= "both",
                             theta = theta, threshold = threshold,overdispfloor=overdispfloor))

names(res)
```

### Diagnostics and Maps

Now that we have performed the toy simulation above, we can save the results to a csv for further analysis and exploration.

**END: 2019-03-19**

Save diagnostics into csv. The csv will save into the \textit{vignettes} folder. To save somewhere else, change the file path where I set *filename*.

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio), "NULL"))
filename <- paste0(sim.i,".RData") #to change where this saves to, for example into a subfolder called 'results', then: paste0("results/",sim.i, ".RData")
save(res, file = filename) #save it!

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect_out.qp.st), rbind("Pois",res$detect_out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect_out.qp.s), rbind("Pois",res$detect_out.p.s)))) #I like to see what this looks like before I save to csv
table.detection.null <- rbind(table.detection.null, tabn) #you don't technically need this step here, but for the parameter sweep below you do, so I kept it in here for consistency.


#WRITE TO CSV
print(table.detection.null)
write.csv(table.detection.null, file="tabledetectionNULL_4_16_18.csv", row.names=TRUE) #again, if you want to change this so it saves to your hypothetical 'results' sub-folder located inside vignettes on your local machine, then: write.csv(table.detection.null, file="results/tabledetectionNULL.csv", row.names=TRUE)


```


Make some maps!

- For the null model there will be a total of 8 maps produced:
    - "probabilitymapsNULL_testPoissonspace.pdf"
    - "probabilitymapsNULL_testPoissonST.pdf"
    - "probabilitymapsNULL_testQuasiPoissonspace.pdf"
    - "probabilitymapsNULL_testQuasiPoissonST.pdf"
    - "rrmapsNULL_testPoissonspace.pdf"
    - "rrmapsNULL_testPoissonST.pdf"
    - "rrmapsNULL_testQuasiPoissonspace.pdf"
    - "rrmapsNULL_testQuasiPoissonST.pdf"
    
- If you change the filename, the prefix will be slightly different, but the ```easyplot()``` function will automatically add the following ends:
    - "Poissonspace.pdf"
    - "PoissonST.pdf"
    - "QuasiPoissonspace.pdf"
    - "QuasiPoissonST.pdf"

- It is the responsibility of the user to keep track of which are the probability results (% of *nsim*) versus relative risk maps.

```{r}
#set file names for the maps - you can change these to be whatever you want.
pdfname1 <- paste0("rrmapsNULL_test4_16_18.pdf")
pdfname2 <- paste0("probabilitymapsNULL_test4_16_18.pdf")

#use easyplot
easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL, rr=TRUE)
easyplot(japan.prefect2, japan.poly2 , pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL,rr=FALSE)



#make the threshold maps too!
```

In the code above, I also specify a parameter called ```threshold <- c(0.9, 0.5)```. This is an additional diagnostic that you can plot, but is not automatic. This will plot the percent of *nsim* simulations where coverage of the detected cluster is at least 90%/50% of the true cluster. This is mostly used for the parameter sweep (below) as an additional visualization and is still in development (as of 1-15-2018).

```{r}
#set threshold pdf names
pdfname3 <- paste0("probmapsthresh1NULL_test4_16_18.pdf")
pdfname4 <- paste0("probmapsthresh2NULL_test4_16_18.pdf")

#easyplot threshold results.
easyplot(japan.prefect2, japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL,rr=FALSE)
easyplot(japan.prefect2, japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)


```


Next, we will run models with actual clusters to detect and do parameter sweep across various criteria combinations.


## Running single simulation without covariates

We can also run simulations to detect a single cluster (parameter sweep example is last).

```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]


```


Import dataframe:

```{r}
#Set-up
data(japanbreastcancer)
str(japanbreastcancer)

#you should be sure to take time to perform exploratory data analysis on your data prior to running.
```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
#nsim <- 100
nsim <- 100 #again, nsim is limited to 100 here for illustration only. For an actual simulation, nsim=100 is recommended
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")

```

### Set conditions for cluster

```{r}
#center <- 150 #can take values 1 - 208 because we have a total of 208 centroids
center <- 75
#radius <- 11
radius <- 18
timeperiods <- c(3:5)
#risk.ratio <- 1.5
risk.ratio <- 1.5
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
#theta <- NULL #with minimal overdispersion (default is 1000). No option for absolutely no overdispersion (yet) TODO
theta <- 1000
table.detection <- NULL
overdispfloor=TRUE
maxclust <- 10


```



```{r}
japanbreastcancer <- japanbreastcancer[,-1] #need to get rid of id's

clst <- toclust(japanbreastcancer, expected = expdeath, observed = death, timeperiod = period, covars=FALSE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, paneldat=TRUE, threshold, analysis= "both", maxclust,theta, nullmod, overdispfloor))

```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio)))
filename <- paste0(sim.i,"_singlesimexample.RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="tabledetection_singlesimexample.csv", row.names=TRUE)


```

We can also output the threshold results, just to explore additional diagnostics (still underdevelopment, please [report any bugs](https://github.com/mkamenet3/cluST/issues)!)

```{r}
#threshold results

(thresh.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio)))
filename <- paste0(sim.i,"thresh_singlesimexampleRData")
save(res, file = filename)

titles <- res$detect.out.thresh.qp.s$threshresults[1,10:18]
(tabn.thresh <- rbind(c("thresh",titles,"Mod"), 
                     rbind(cbind(threshold, res$detect.out.thresh.p.s$threshresults[,1:9], "PS"),
                           cbind(threshold, res$detect.out.thresh.qp.s$threshresults[,1:9],"QPS"),
                           cbind(threshold, res$detect.out.thresh.p.st$threshresults[,1:9],"PST"),
                           cbind(threshold, res$detect.out.thresh.qp.st$threshresults[,1:9],"QPST"))))

#WRITE TO CSV
print(tabn.thresh) 
write.csv(tabn.thresh, file="tabledetectionthresh_singlesimexample.csv", row.names=TRUE)
```


Make maps!


```{r}
pdfname1 <- paste0("rrmaps_singlesimexample.pdf")
pdfname2 <- paste0("probabilitymaps_singlesimexample.pdf")
pdfname3 <- paste0("probmapsthresh1_singlesimexample.pdf")
pdfname4 <- paste0("probmapsthresh2_singlesimexample.pdf")


easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL, rr=TRUE)
easyplot(japan.prefect2, japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)
easyplot(japan.prefect2, japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)
easyplot(japan.prefect2, japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)

```





## Running simulation with covariates


We also allow for the model to take on covariates, which are specified in the ```clst``` class definition and are then passed to the larger ```clust_sim()``` function.

Import geography data:

```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]


```



Import dataframe with covariates:

```{r}
#Set-up
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]

#add a couple of covariates to the dataframe
covar1 <- rnorm(n = nrow(japanbreastcancer),mean = 500, sd = 30)
covar2 <- rpois(n = nrow(japanbreastcancer), lambda = japanbreastcancer$expdeath)
covar3 <- rbinom(n = nrow(japanbreastcancer), size = 50, prob = 0.7)
covar4 <- rbinom(n = nrow(japanbreastcancer), 1, 0.5)
covar5 <- rbinom(n = nrow(japanbreastcancer), 1, 0.2)

#add new covariates to dataframe
df <- cbind.data.frame(japanbreastcancer[,-1], covar1, covar2, covar3, covar4, covar5)

#check out the new dataframe
head(df)

```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
nsim <- 100
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")

```

### Set conditions for cluster

```{r}
center <- 35 #can take values 1 - 208 because we have a total of 208 centroids
radius <- 18
timeperiods <- c(3:5)
risk.ratio <- 2
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- 2 #with overdispersion. For no overdispersion, set theta = NULL


table.detection <- NULL

```



```{r}

clst <- toclust(df, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death, timeperiod = japanbreastcancer$period, covars=TRUE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, overdispfloor))

```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio), "NULLCOVARS"))
filename <- paste0("sampleoutput/",sim.i,"SPAT.RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="sampleoutput/tabledetection_covarsexample.csv", row.names=TRUE)


```


Make maps!


```{r}
pdfname1 <- paste0("rrmaps_covarsexample.pdf")
pdfname2 <- paste0("probabilitymaps_covarsexample.pdf")
pdfname3 <- paste0("probmapsthresh1_covarsexample.pdf")
pdfname4 <- paste0("probmapsthresh2_covarsexample.pdf")


easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL)
easyplot(japan.prefect2, japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(japan.prefect2, japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(japan.prefect2, japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL)

```





## Running Cluster Model with Multiple Simulated Clusters

We use the same dataset as before.

Set initial conditions:

```{r}
#Set Some Initial Conditions
x=utmJapan$utmx/1000
y=utmJapan$utmy/1000
rMax=20
Time=5
#nsim=100
nsim=2 #change number of simulations. nsim set to 2 here for illustration
```

- The parameters you can explore in the model are:
    - *centers* - different centroids across the model that can serve as the cluster center
    - *radii* - various radii distances the cluster can take
    - *timeperiods* - the cluster can exist across different time periods. Currently (as of 1-15-2018), the time periods do need to be sequential. For example, if there are a total of 5 time periods, the cluster cannot exist in period 1 and then period 4. TODO.
    - *risk.ratios* - the relative risk of the cluster compared to the background rate of the area.

- Additional modifications you can include:
    - *theta* - default is 1000 (minimal overdispersion). Our simulations explore both this case and the case when ```theta=2``` which includes a lot of overdispersion. This was to illustrate how our model performs under various schemes and the user can also set this various values, especially depending on the subject area.
    - *overdispfloor* - default is TRUE (we do not allow for underdispersion). However, the user can set ```overdispfloor <- FALSE``` to allow for it


```{r}

#set different combinations of parameters.
centers <- c(150, 35)
radii <- c(9, 11, 18)
timeperiods <- list(c(3:5), c(1:2), c(2:4))
risk.ratios <- c(1.1, 1.5, 2)
nullmod = NULL
theta = 2 #with lots overdispersion. For no overdispersion, set theta = NULL
overdispfloor = TRUE

table.detection <- NULL
```



Run multiple models (in a giant loop). The code below is the same as the null case above, except we loop through the various parameters.

```{r}
for(cent in centers){
    for(rad in radii){
        for(tim in timeperiods){
            for(risk in risk.ratios){
                print(c(cent, rad, tim, risk))
                system.time(res <- clust_sim(clst,x, y,rMax,Time,
                                             nsim,cent, rad, risk, tim, utm=TRUE, byrow=TRUE, threshold, 
                                             space= "both", theta, nullmod, overdispfloor))
                #save results
                (sim.i <- paste0("sim","_","center","_",cent,"radius",rad,"_", "start",
                                 "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk)))
                filename <- paste0("sampleoutput/",sim.i,".RData")
                save(res, file = filename)

                #Print Detection for the Simulation
                (tabn <- rbind("******",cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "ST",
                                               rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
                                cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "Space",
                                      rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))
                table.detection <- rbind(table.detection, tabn)

                #Print Descriptives

                #make maps
                    ##pdfnames
                pdfnamerr <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                  "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"RR.pdf")
                pdfnameprob <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                    "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"prob.pdf")
                pdfnamethresh1 <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                      "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"thr1.pdf")
                pdfnamethresh2 <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                         "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"thr2.pdf")
                ##maps
                easyplot(japan.prefect2, japan.poly2 ,pdfnamerr, res$rrcolors, mods, space="both",probmap=FALSE, obs=NULL, rr=TRUE)
                easyplot(japan.prefect2, japan.poly2 , pdfnameprob, res$probcolors, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                easyplot(japan.prefect2, japan.poly2 ,pdfnamethresh1, res$probcolors.thresh1, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                easyplot(japan.prefect2, japan.poly2 , pdfnamethresh2, res$probcolors.thresh2, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)

            }
        }
    }
}

```

Write output to csv:

```{r}

#WRITE TO CSV
print(table.detection)
write.csv(table.detection, file="tabledetectionclustersim.csv", row.names=TRUE)

#Print Table Detection
table.detection
print(table.detection)

```


## Running Simulation Varying the Background Rate

Instead of varying the relative risk inside the cluster we can instead vary the background risk rate and explore how well our method does if the background rate is larger or smaller. The initial set-up will be similar.


```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]
```

Set-up initial inputs:

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
nsim <- 100
#nsim <- 2 #again, nsim is limited to 100 here for illustration only. For an actual simulation, nsim=100 is recommended
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")
```

```{r}
center <- 150 #can take values 1 - 208 because we have a total of 208 centroids
radius <- 18
timeperiod <- c(3:5)

#Change in syntax here:
background.rate <- 0.5
risk.ratio <- 1

#as before
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- NULL #with minimal overdispersion (default is 1000). No option for absolutely no overdispersion (yet) TODO
table.detection <- NULL

```


Run the model with varying background rate:

```{r}
japanbreastcancer <- japanbreastcancer[,-1] #need to get rid of id's

clst <- toclust(japanbreastcancer, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death, timeperiod = japanbreastcancer$period, covars=FALSE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, overdispfloor,
                             background.rate=background.rate))
```

###Diagnostics and Maps

```{r}
#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio)))
(filename <- paste0(sim.i,"_bkgrndratesimexample.RData"))
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="tabledetection_bkgrndratesimexample.csv", row.names=TRUE)


```


Making more maps!


```{r}
pdfname1 <- paste0("rrmaps_bkgrndratesimexample.pdf")
pdfname2 <- paste0("probabilitymaps_bkgrndratesimexample.pdf")
pdfname3 <- paste0("probmapsthresh1_bkgrndratesimexample.pdf")
pdfname4 <- paste0("probmapsthresh2_bkgrndratesimexample.pdf")


easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL, rr=TRUE)
easyplot(japan.prefect2, japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)


```


## Running Background Rate Model with Multiple Background Rates

To explore how detection works when the background rate is varied, we can perform a similar large-scale simulation varying our multiple parameters.


```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]
```


```{r}
#Set initial
#Set Some Initial Conditions
x=utmJapan$utmx/1000
y=utmJapan$utmy/1000
rMax=20
Time=5
#nsim=100
nsim=2 #change number of simulations. nsim set to 2 here for illustration

```


```{r}
#set different combinations of parameters.
centers <- c(150)
radii <- c(9,18)
timeperiods <- list(c(3:5))
risk.ratios <- c(1.5, 2)
background.rates <- c(0.5,2)
nullmod = NULL
thetas = c(Inf, 2, 1000) #with lots overdispersion. For no overdispersion, set theta = NULL
overdispfloor <- TRUE

table.detection <- NULL
```

Run the huge model:


```{r}
#tester
for(cent in centers){
    for(rad in radii){
        for(tim in timeperiods){
            for(risk in risk.ratios){
                for(thet in thetas){
                    for(back in background.rates){
                        #print(c(cent, rad, tim, risk,back,theta))
                        print(paste0("sim","_","bkgrd","_",back,"radius",rad,"_", "theta",
                                         "_",as.character(thet),"_",
                                         "rr","_",gsub("[.]","",risk)))
                    }
                    
                }
            }
        }
    }
}

```



```{r}
for(cent in centers){
    for(rad in radii){
        for(tim in timeperiods){
            for(risk in risk.ratios){
                for(thet in thetas){
                    for(back in background.rates){
                        print(c(cent, rad, tim, risk,back,thet))
                        system.time(res <- clust_sim(clst,x, y,rMax,Time,
                                                     nsim,cent, rad, risk, tim, utm=TRUE, byrow=TRUE, threshold, 
                                                     space= "both", thet, nullmod, overdispfloor,
                                                     background.rate = back))
                        #save results
                        (sim.i <- paste0("sim","_","bkgrd","_",back,"radius",rad,"_", "theta",
                                         "_",as.character(thet),"_",
                                         "rr","_",gsub("[.]","",risk)))
                        filename <- paste0(sim.i,".RData")
                        save(res, file = filename)
                        
                        #Print Detection for the Simulation
                        (tabn <- rbind("******",cbind(rad,risk,cent,back,thet,
                                                      time=as.numeric(paste(tim, collapse = "")),
                                                      mod = "ST", rbind("QuasiPois",res$detect.out.qp.st),
                                                      rbind("Pois",res$detect.out.p.st)),
                                       cbind(rad,risk,cent,back,thet,time=as.numeric(paste(tim, collapse = "")),
                                             mod = "Space",
                                             rbind("QuasiPois",res$detect.out.qp.s),
                                             rbind("Pois",res$detect.out.p.s))))
                        table.detection <- rbind(table.detection, tabn)
                        
                        #Print Descriptives
                        
                        #make maps
                        ##pdfnames
                        pdfnamerr <- paste0("OUT/sim","_","bkgrd","_",back,"radius",rad,"_", "theta",
                                            "_",as.character(thet),
                                            "_","rr","_",gsub("[.]","",risk),"RR.pdf")
                        pdfnameprob <- paste0("OUT/sim","_","bkgrd","_",back,"radius",rad,"_", "theta",
                                              "_",as.character(thet),
                                              "_","rr","_",gsub("[.]","",risk),"prob.pdf")
                        pdfnamethresh1 <- paste0("OUT/sim","_","bkgrd","_",back,"radius",rad,"_", "theta",
                                                 "_",as.character(thet),
                                                 "_","rr","_",gsub("[.]","",risk),"thr1.pdf")
                        pdfnamethresh2 <- paste0("OUT/sim","_","bkgrd","_",back,"radius",rad,"_", "theta",
                                                 "_",as.character(thet),
                                                 "_","rr","_",gsub("[.]","",risk),"thr2.pdf")
                        ##maps
                        easyplot(japan.prefect2, japan.poly2 ,pdfnamerr, res$rrcolors, mods,
                                 space="both",probmap=FALSE, obs=NULL, rr=TRUE)
                        easyplot(japan.prefect2, japan.poly2 , pdfnameprob, res$probcolors, mods,
                                 space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                        easyplot(japan.prefect2, japan.poly2 ,pdfnamethresh1, res$probcolors.thresh1, mods,
                                 space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                        easyplot(japan.prefect2, japan.poly2 , pdfnamethresh2, res$probcolors.thresh2, mods,
                                 space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                        
                    }
                }
            }
        }
    }
}


```

