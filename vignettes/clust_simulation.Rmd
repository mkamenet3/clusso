---
title: "Running *clust* with Simulations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to clust}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


#Introduction

This package is still under development. Please [report any bugs](https://github.com/mkamenet3/cluST/issues).


Load *clust*

```{r, message=FALSE, warning=FALSE}
#load package
library("clust")

```


## Running the Null Model (no cluster to detect) with minimal overdispersion

For speed, I set $nsim=2$, but you should feel free to ramp this up to 100. No covariates are shown here.

### Prepare Data


```{r}
set.seed(8202017)

#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]
```



### Set global conditions


Set threshold(s):

```{r}
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")
```

Set the easting and northing coordinates:

```{r}
x=utmJapan$utmx/1000
y=utmJapan$utmy/1000

```

Set other conditions. Right now, the null model requires to still input a center and radius even for the null case, but this will be adjusted in future versions. For poisson model with no overdispersion, set ```theta=Inf```.

```{r}
rMax=20
Time=5
#nsim=100 #number of simulations
nsim = 2 #feel free to change this back to 100

#need inputs for model to run
center=1
radius=18
timeperiod = c(1:5)
risk.ratio=1
#theta = 1000
theta = Inf
overdispfloor = TRUE
nullmod <- NULL
table.detection.null <- NULL

```


### Running the models


Run the null model and store results into object $res$.

```{r}
japanbreastcancer<- japanbreastcancer[,-1] #get rid of id column to use clst function

#create clst class object
clst <- toclust(japanbreastcancer, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death,timeperiod = japanbreastcancer$period, covars = FALSE) #no covariates here!

#run clust_sim and time it
system.time(res <- clust_sim(clst, x,y,rMax, Time,
                                 nsim,center, radius, risk.ratio, timeperiod,
                                 utm=TRUE, byrow=TRUE, threshold, space= "both",
                             theta = theta, nullmod = TRUE, overdispfloor))
```

### Diagnostics and Maps

Save diagnostics into csv. The csv will save into the \textit{vignettes} folder. To save somewhere else, change the file path where I set $filename$.

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio), "NULL"))
filename <- paste0(sim.i,".RData") #to change where this saves to, for example into a subfolder called 'results', then: paste0("results/",sim.i, ".RData")
save(res, file = filename) #save it!

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s)))) #I like to see what this looks like before I save to csv
table.detection.null <- rbind(table.detection.null, tabn) #you don't technically need this step here, but for the parameter sweep below you do, so I kept it in here for consistency.


#WRITE TO CSV
print(table.detection.null)
write.csv(table.detection.null, file="tabledetectionNULL.csv", row.names=TRUE) #again, if you want to change this so it saves to your hypothetical 'results' sub-folder located inside vignettes on your local machine, then: write.csv(table.detection.null, file="results/tabledetectionNULL.csv", row.names=TRUE)


```


Make some maps!

- For the null model there will be a total of 8 maps produced:
    - "probabilitymapsNULL_testPoissonspace.pdf"
    - "probabilitymapsNULL_testPoissonST.pdf"
    - "probabilitymapsNULL_testQuasiPoissonspace.pdf"
    - "probabilitymapsNULL_testQuasiPoissonST.pdf"
    - "rrmapsNULL_testPoissonspace.pdf"
    - "rrmapsNULL_testPoissonST.pdf"
    - "rrmapsNULL_testQuasiPoissonspace.pdf"
    - "rrmapsNULL_testQuasiPoissonST.pdf"
    
- If you change the filename, the prefix will be slightly different, but the ```easyplot()``` function will automatically add the following ends:
    - "Poissonspace.pdf"
    - "PoissonST.pdf"
    - "QuasiPoissonspace.pdf"
    - "QuasiPoissonST.pdf"

- It is the responsibility of the user to keep track of which are the probability results (% of $nsim$) versus relative risk maps.

```{r}
#set file names for the maps - you can change these to be whatever you want.
pdfname1 <- paste0("rrmapsNULL_test.pdf")
pdfname2 <- paste0("probabilitymapsNULL_test.pdf")

#use easyplot
easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL, rr=TRUE)
easyplot(japan.prefect2, japan.poly2 , pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL,rr=FALSE)



#make the threshold maps too!
```

In the code above, I also specify a parameter called ```threshold <- c(0.9, 0.5)```. This is an additional diagnostic that you can plot, but is not automatic. This will plot the percent of $nsim$ simulations where coverage of the detected cluster is at least 90%/50% of the true cluster. This is mostly used for the parameter sweep (below) as an additional visualization and is still in development (as of 1-15-2018).

```{r}
#set threshold pdf names
pdfname3 <- paste0("probmapsthresh1NULL_test.pdf")
pdfname4 <- paste0("probmapsthresh2NULL_test.pdf")

#easyplot threshold results.
easyplot(japan.prefect2, japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL,rr=FALSE)
easyplot(japan.prefect2, japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)


```


Next, we will run models with actual clusters to detect and do parameter sweep across various criteria combinations.


## Running single simulation without covariates

We can also run simulations to detect a single cluster (parameter sweep example is last).

```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]


```


Import dataframe:

```{r}
#Set-up
data(japanbreastcancer)
str(japanbreastcancer)

#you should be sure to take time to perform exploratory data analysis on your data prior to running.
```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
#nsim <- 100
nsim <- 2 #again, nsim is limited to 100 here for illustration only. For an actual simulation, nsim=100 is recommended
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")

```

### Set conditions for cluster

```{r}
center <- 150 #can take values 1 - 208 because we have a total of 208 centroids
radius <- 18
timeperiods <- c(3:5)
risk.ratio <- 2
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- NULL #with minimal overdispersion (default is 1000). No option for absolutely no overdispersion (yet) TODO
table.detection <- NULL

```



```{r}
japanbreastcancer <- japanbreastcancer[,-1] #need to get rid of id's

clst <- toclust(japanbreastcancer, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death, timeperiod = japanbreastcancer$period, covars=FALSE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, overdispfloor))

```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio)))
filename <- paste0(sim.i,"_singlesimexample.RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="sampleoutput/tabledetection_singlesimexample.csv", row.names=TRUE)


```

We can also output the threshold results, just to explore additional diagnostics (still underdevelopment, please [report any bugs](https://github.com/mkamenet3/cluST/issues)!)

```{r}
#threshold results

(thresh.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio)))
filename <- paste0(sim.i,"thresh_singlesimexampleRData")
save(res, file = filename)

titles <- res$detect.out.thresh.qp.s$threshresults[1,10:18]
(tabn.thresh <- rbind(c("thresh",titles,"Mod"), 
                     rbind(cbind(threshold, res$detect.out.thresh.p.s$threshresults[,1:9], "PS"),
                           cbind(threshold, res$detect.out.thresh.qp.s$threshresults[,1:9],"QPS"),
                           cbind(threshold, res$detect.out.thresh.p.st$threshresults[,1:9],"PST"),
                           cbind(threshold, res$detect.out.thresh.qp.st$threshresults[,1:9],"QPST"))))

#WRITE TO CSV
print(tabn.thresh) 
write.csv(tabn.thresh, file="tabledetectionthresh_singlesimexample.csv", row.names=TRUE)
```


Make maps!


```{r}
pdfname1 <- paste0("rrmaps_singlesimexample.pdf")
pdfname2 <- paste0("probabilitymaps_singlesimexample.pdf")
pdfname3 <- paste0("probmapsthresh1_singlesimexample.pdf")
pdfname4 <- paste0("probmapsthresh2_singlesimexample.pdf")


easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL, rr=TRUE)
easyplot(japan.prefect2, japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)
easyplot(japan.prefect2, japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)
easyplot(japan.prefect2, japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)

```





## Running simulation with covariates


We also allow for the model to take on covariates, which are specified in the ```clst``` class definition and are then passed to the larger ```clust_sim()``` function.

Import geography data:

```{r}
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]


```



Import dataframe with covariates:

```{r}
#Set-up
#load data
data("japanbreastcancer")

#inspect
head(utmJapan)
head(dframe.poly2)
head(dframe.prefect2)
head(japanbreastcancer)

#take what we need
japan.poly2 <- dframe.poly2[,2:3]
japan.prefect2 <- dframe.prefect2[,2:5]

#add a couple of covariates to the dataframe
covar1 <- rnorm(n = nrow(japanbreastcancer),mean = 500, sd = 30)
covar2 <- rpois(n = nrow(japanbreastcancer), lambda = japanbreastcancer$expdeath)
covar3 <- rbinom(n = nrow(japanbreastcancer), size = 50, prob = 0.7)
covar4 <- rbinom(n = nrow(japanbreastcancer), 1, 0.5)
covar5 <- rbinom(n = nrow(japanbreastcancer), 1, 0.2)

#add new covariates to dataframe
df <- cbind.data.frame(japanbreastcancer[,-1], covar1, covar2, covar3, covar4, covar5)

#check out the new dataframe
head(df)

```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- utmJapan$utmx/1000
y <- utmJapan$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
nsim <- 100
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")

```

### Set conditions for cluster

```{r}
center <- 35 #can take values 1 - 208 because we have a total of 208 centroids
radius <- 18
timeperiods <- c(3:5)
risk.ratio <- 2
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- 2 #with overdispersion. For no overdispersion, set theta = NULL


table.detection <- NULL

```



```{r}

clst <- toclust(df, expected = japanbreastcancer$expdeath, observed = japanbreastcancer$death, timeperiod = japanbreastcancer$period, covars=TRUE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, overdispfloor))

```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio), "NULLCOVARS"))
filename <- paste0("sampleoutput/",sim.i,"SPAT.RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="sampleoutput/tabledetection_covarsexample.csv", row.names=TRUE)


```


Make maps!


```{r}
pdfname1 <- paste0("rrmaps_covarsexample.pdf")
pdfname2 <- paste0("probabilitymaps_covarsexample.pdf")
pdfname3 <- paste0("probmapsthresh1_covarsexample.pdf")
pdfname4 <- paste0("probmapsthresh2_covarsexample.pdf")


easyplot(japan.prefect2, japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL)
easyplot(japan.prefect2, japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(japan.prefect2, japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(japan.prefect2, japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL)

```





## Running Cluster Model with Multiple Simulated Clusters

We use the same dataset as before.

Set initial conditions:

```{r}
#Set Some Initial Conditions
x=utmJapan$utmx/1000
y=utmJapan$utmy/1000
rMax=20
Time=5
#nsim=100
nsim=2 #change number of simulations. nsim set to 2 here for illustration
```

- The parameters you can explore in the model are:
    - $centers$ - different centroids across the model that can serve as the cluster center
    - $radii$ - various radii distances the cluster can take
    - $timeperiods$ - the cluster can exist across different time periods. Currently (as of 1-15-2018), the time periods do need to be sequential. For example, if there are a total of 5 time periods, the cluster cannot exist in period 1 and then period 4. TODO.
    - $risk.ratios$ - the relative risk of the cluster compared to the background rate of the area.

- Additional modifications you can include:
    - $theta$ - default is 1000 (minimal overdispersion). Our simulations explore both this case and the case when ```theta=2``` which includes a lot of overdispersion. This was to illustrate how our model performs under various schemes and the user can also set this various values, especially depending on the subject area.
    - $overdispfloor$ - default is TRUE (we do not allow for underdispersion). However, the user can set ```overdispfloor <- FALSE``` to allow for it


```{r}

#set different combinations of parameters.
centers <- c(150, 35)
radii <- c(9, 11, 18)
timeperiods <- list(c(3:5), c(1:2), c(2:4))
risk.ratios <- c(1.1, 1.5, 2)
nullmod = NULL
theta = 2 #with lots overdispersion. For no overdispersion, set theta = NULL
overdispfloor = TRUE

table.detection <- NULL
```



Run multiple models (in a giant loop). The code below is the same as the null case above, except we loop through the various parameters.

```{r}
for(cent in centers){
    for(rad in radii){
        for(tim in timeperiods){
            for(risk in risk.ratios){
                print(c(cent, rad, tim, risk))
                system.time(res <- clust_sim(clst,x, y,rMax,Time,
                                             nsim,cent, rad, risk, tim, utm=TRUE, byrow=TRUE, threshold, 
                                             space= "both", theta, nullmod, overdispfloor))
                #save results
                (sim.i <- paste0("sim","_","center","_",cent,"radius",rad,"_", "start",
                                 "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk)))
                filename <- paste0("sampleoutput/",sim.i,".RData")
                save(res, file = filename)

                #Print Detection for the Simulation
                (tabn <- rbind("******",cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "ST",
                                               rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
                                cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "Space",
                                      rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))
                table.detection <- rbind(table.detection, tabn)

                #Print Descriptives

                #make maps
                    ##pdfnames
                pdfnamerr <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                  "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"RR.pdf")
                pdfnameprob <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                    "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"prob.pdf")
                pdfnamethresh1 <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                      "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"thr1.pdf")
                pdfnamethresh2 <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                         "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"thr2.pdf")
                ##maps
                easyplot(japan.prefect2, japan.poly2 ,pdfnamerr, res$rrcolors, mods, space="both",probmap=FALSE, obs=NULL, rr=TRUE)
                easyplot(japan.prefect2, japan.poly2 , pdfnameprob, res$probcolors, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                easyplot(japan.prefect2, japan.poly2 ,pdfnamethresh1, res$probcolors.thresh1, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                easyplot(japan.prefect2, japan.poly2 , pdfnamethresh2, res$probcolors.thresh2, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)

            }
        }
    }
}

```

Write output to csv:

```{r}

#WRITE TO CSV
print(table.detection)
write.csv(table.detection, file="tabledetectionclustersim.csv", row.names=TRUE)

#Print Table Detection
table.detection
print(table.detection)

```

