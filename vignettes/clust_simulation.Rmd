---
title: "Running *clust* with Simulations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to clust}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


#Introduction

Load *clust*

```{r, message=FALSE, warning=FALSE}
library("clust")
```


## Running the Null Model (no cluster to detect)

### Prepare Data


```{r}
set.seed(8202017)

dframe1 <- read.csv("../data/jap.breast.F.9.10.11.csv")
dframe2 <- read.csv("../data/utmJapan.csv")
dframe3 <- aggregate(dframe1, by=list(as.factor(rep(1:(nrow(dframe1)/4),each=4))), FUN="sum")
dframe=data.frame(id=as.factor(dframe3$id/4),period=as.factor(dframe3$year),death=dframe3$death,expdeath=dframe3$expdeath)
levels(dframe$period) <- c("1","2","3","4","5")

dframe.poly2 <- read.csv("../data/japan_poly2.csv")
japan.poly2 <- dframe.poly2[,2:3]
dframe.prefect2 <- read.csv("../data/japan_prefect2.csv")
japan.prefect2 <- dframe.prefect2[,2:5]

head(dframe)
head(dframe.poly2)
head(dframe.prefect2)
```



### Set global conditions


Set threshold(s):

```{r}
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")
```

Set the easting and northing coordinates:

```{r}
x=dframe2$utmx/1000
y=dframe2$utmy/1000

```

Set other conditions. Right now, the null model requires to still input a center and radius even for the null case, but this will be adjusted in future versions.

```{r}
rMax=20
Time=5
#nsim=100 #number of simulations
nsim = 20

#need inputs for model to run
center=1
radius=18
timeperiods = c(1:5)
risk.ratio=1
theta = 10000
overdispfloor = TRUE
nullmod <- TRUE
table.detection.null <- NULL

```


### Running the models


Run the null model and store results into object $res$.

```{r}
dframe <- dframe[,-1]

clst <- toclust(dframe, expected = dframe$expdeath, observed = dframe$death,timeperiod = dframe$period, covars = FALSE)

system.time(res <- clust_sim(clst, x,y,rMax, Time,
                                 nsim,center, radius, risk.ratio, timeperiod,
                                 utm=TRUE, byrow=TRUE, threshold, space= "both",
                             theta = theta, nullmod = TRUE, overdispfloor))
```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio), "NULL"))
filename <- paste0("sampleoutput/",sim.i,".RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))
table.detection.null <- rbind(table.detection.null, tabn)


#WRITE TO CSV
print(table.detection.null)
write.csv(table.detection.null, file="tabledetectionNULL.csv", row.names=TRUE)


```


Make maps!

```{r}
#make maps
#pdfname <- paste0("sampleoutput/sim","_","center","_",center,"radius",radius,"_", "start",
 #                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio),"NULL.pdf")
pdfname1 <- paste0("rrmapsNULLtest2mult.pdf")
pdfname2 <- paste0("probabilitymapsNULLtest2mult.pdf")
pdfname3 <- paste0("probmapsthresh1NULLtest2mult.pdf")
pdfname4 <- paste0("probmapsthresh2NULLtest2mult.pdf")



easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL, rr=TRUE)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL,rr=FALSE)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL,rr=FALSE)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL, rr=FALSE)




#easyplot(pdfname, res, mods, space="both")
```




## Running Cluster Model with Multiple Simulated Clusters

We use the same dataset as before

Set initial conditions:

```{r}
#Set Some Initial Conditions
x=dframe2$utmx/1000
y=dframe2$utmy/1000
rMax=20
Time=5
#nsim=100
nsim=2 #change number of simulations


centers <- c(150, 35)
radii <- c(9, 11, 18)
timeperiods <- list(c(3:5), c(1:2), c(2:4))
risk.ratios <- c(1.1, 1.5, 2)
nullmod = NULL
theta = 2 #with overdispersion. For no overdispersion, set theta = NULL
overdispfloor = TRUE

table.detection <- NULL
```



Run multiple models:

```{r}
for(cent in centers){
    for(rad in radii){
        for(tim in timeperiods){
            for(risk in risk.ratios){
                print(c(cent, rad, tim, risk))
                system.time(res <- clust_sim(clst,x, y,rMax,Time,
                                             nsim,cent, rad, risk, tim, utm=TRUE, byrow=TRUE, threshold, 
                                             space= "both", theta, nullmod, overdispfloor))
                #save results
                (sim.i <- paste0("sim","_","center","_",cent,"radius",rad,"_", "start",
                                 "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk)))
                filename <- paste0("sampleoutput/",sim.i,".RData")
                save(res, file = filename)

                #Print Detection for the Simulation
                (tabn <- rbind("******",cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "ST",
                                               rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
                                cbind(rad,risk,cent,time=as.numeric(paste(tim, collapse = "")), mod = "Space",
                                      rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))
                table.detection <- rbind(table.detection, tabn)

                #Print Descriptives

                #make maps
                    ##pdfnames
                pdfnamerr <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                  "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"RR.pdf")
                pdfnameprob <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                    "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"prob.pdf")
                pdfnamethresh1 <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                      "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"thr1.pdf")
                pdfnamethresh2 <- paste0("OUT/sim","_","center","_",cent,"radius",rad,"_", "start",
                                         "_",as.numeric(paste(tim, collapse = "")),"_","rr","_",gsub("[.]","",risk),"thr2.pdf")
                ##maps
                easyplot(prefect = japan.prefect2 , polygons = japan.poly2, pdfnamerr, res$rrcolors, mods, space="both",probmap=FALSE, obs=NULL, rr=TRUE)
                easyplot(prefect = japan.prefect2 , polygons = japan.poly2, pdfnameprob, res$probcolors, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                easyplot(prefect = japan.prefect2 , polygons = japan.poly2, pdfnamethresh1, res$probcolors.thresh1, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)
                easyplot(prefect = japan.prefect2 , polygons = japan.poly2, pdfnamethresh2, res$probcolors.thresh2, mods, space="both",probmap=TRUE, obs=NULL, rr=FALSE)

            }
        }
    }
}

```

Write output to csv:

```{r}

#WRITE TO CSV
print(table.detection)
write.csv(table.detection, file="sampleoutput/tabledetectionclustersim.csv", row.names=TRUE)

#Print Table Detection
table.detection
print(table.detection)

```

## Running single simulation without covariates

```{r}

dframe.poly2 <- read.csv("../data/japan_poly2.csv")
japan.poly2 <- dframe.poly2[,2:3]
dframe.prefect2 <- read.csv("../data/japan_prefect2.csv")
japan.prefect2 <- dframe.prefect2[,2:5]

head(dframe.poly2)
head(dframe.prefect2)


```



Import dataframe with covariates:

```{r}
#Set-up
dframe1 <- read.csv("../data/jap.breast.F.9.10.11.csv")
dframe2 <- read.csv("../data/utmJapan.csv")
dframe3 <- aggregate(dframe1, by=list(as.factor(rep(1:(nrow(dframe1)/4),each=4))), FUN="sum")
dframe=data.frame(id=as.factor(dframe3$id/4),period=as.factor(dframe3$year),death=dframe3$death,expdeath=dframe3$expdeath)
levels(dframe$period) <- c("1","2","3","4","5")
#assume this is what you start with
```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- dframe2$utmx/1000
y <- dframe2$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
nsim <- 100
#nsim <- 10
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")

```

### Set conditions for cluster

```{r}
center <- 150 #can take values 1 - 208 because we have a total of 208 centroids
#center <- 35
radius <- 18
timeperiods <- c(3:5)
risk.ratio <- 2
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- NULL #with overdispersion. For no overdispersion, set theta = NULL
table.detection <- NULL

```



```{r}
dframe <- dframe[,-1]

clst <- toclust(dframe, expected = dframe$expdeath, observed = dframe$death, timeperiod = dframe$period, covars=FALSE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, overdispfloor))

```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiods, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio)))
filename <- paste0("sampleoutput/",sim.i,"singlesim300.RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiods, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="sampleoutput/tabledetectionsinglesim35_300.csv", row.names=TRUE)


```


Make maps!


```{r}
pdfname1 <- paste0("rrmaps.pdf")
pdfname2 <- paste0("probabilitymaps.pdf")
pdfname3 <- paste0("probmapsthresh1.pdf")
pdfname4 <- paste0("probmapsthresh2.pdf")

# pdfname1 <- paste0("rrmaps_35.pdf")
# pdfname2 <- paste0("probabilitymaps_35.pdf")
# pdfname3 <- paste0("probmapsthresh1_35.pdf")
# pdfname4 <- paste0("probmapsthresh2_35.pdf")

# pdfname1 <- paste0("rrmaps_test.pdf")
# pdfname2 <- paste0("probabilitymaps_test.pdf")
# pdfname3 <- paste0("probmapsthresh1_test.pdf")
# pdfname4 <- paste0("probmapsthresh2_test.pdf")


easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL)

```





## Running simulation with covariates

Import geography data:

```{r}

dframe.poly2 <- read.csv("../data/japan_poly2.csv")
japan.poly2 <- dframe.poly2[,2:3]
dframe.prefect2 <- read.csv("../data/japan_prefect2.csv")
japan.prefect2 <- dframe.prefect2[,2:5]

head(dframe.poly2)
head(dframe.prefect2)


```



Import dataframe with covariates:

```{r}
#Set-up
dframe1 <- read.csv("../data/jap.breast.F.9.10.11.csv")
dframe2 <- read.csv("../data/utmJapan.csv")
dframe3 <- aggregate(dframe1, by=list(as.factor(rep(1:(nrow(dframe1)/4),each=4))), FUN="sum")
dframe=data.frame(id=as.factor(dframe3$id/4),period=as.factor(dframe3$year),death=dframe3$death,expdeath=dframe3$expdeath)
levels(dframe$period) <- c("1","2","3","4","5")

#add a couple of covariates to the dataframe
covar1 <- rnorm(n = nrow(dframe),mean = 500, sd = 30)
covar2 <- rpois(n = nrow(dframe), lambda = dframe$expdeath)
covar3 <- rbinom(n = nrow(dframe), size = 50, prob = 0.7)
covar4 <- rbinom(n = nrow(dframe), 1, 0.5)
covar5 <- rbinom(n = nrow(dframe), 1, 0.2)

#add new covariates to dataframe
df <- cbind.data.frame(dframe[,-1], covar1, covar2, covar3, covar4, covar5)

#check out the new dataframe
head(df)

#assume this is what you start with
```

```{r}
#Initial inputs
mods <- c("QuasiPoisson", "Poisson")
x <- dframe2$utmx/1000
y <- dframe2$utmy/1000
rMax <- 20 
Time <- 5
overdispfloor <- TRUE
nsim <- 100
threshold <- c(0.9, 0.5)
mods <- c("QuasiPoisson", "Poisson")

```

### Set conditions for cluster

```{r}
center <- 35 #can take values 1 - 208 because we have a total of 208 centroids
radius <- 18
timeperiods <- c(3:5)
risk.ratio <- 2
nullmod <- NULL #set to NULL if we want to run non-null model (model with a cluster we've created)
theta <- 2 #with overdispersion. For no overdispersion, set theta = NULL


table.detection <- NULL

```



```{r}

clst <- toclust(df, expected = dframe$expdeath, observed = dframe$death, timeperiod = dframe$period, covars=TRUE)

system.time(res <- clust_sim(clst, x, y,rMax,Time, nsim,center, radius, risk.ratio, timeperiods, 
                             utm=TRUE, byrow=TRUE, threshold, space= "both", theta, nullmod, overdispfloor))

```

### Diagnostics and Maps

Save diagnostics into csv:

```{r}

#save results
(sim.i <- paste0("sim","_","center","_",center,"radius",radius,"_", "start",
                 "_",as.numeric(paste(timeperiod, collapse = "")),"_","rr","_",gsub("[.]","",risk.ratio), "NULLCOVARS"))
filename <- paste0("sampleoutput/",sim.i,"SPAT.RData")
save(res, file = filename)

#Print Detection for the Simulation
(tabn <- rbind("******",cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "ST",
                              rbind("QuasiPois",res$detect.out.qp.st), rbind("Pois",res$detect.out.p.st)),
               cbind(radius,risk.ratio,center,time=as.numeric(paste(timeperiod, collapse = "")), mod = "Space",
                     rbind("QuasiPois",res$detect.out.qp.s), rbind("Pois",res$detect.out.p.s))))

#WRITE TO CSV
print(tabn)
write.csv(tabn, file="sampleoutput/tabledetectioncovars.csv", row.names=TRUE)


```


Make maps!


```{r}
pdfname1 <- paste0("rrmaps.pdf")
pdfname2 <- paste0("probabilitymaps.pdf")
pdfname3 <- paste0("probmapsthresh1.pdf")
pdfname4 <- paste0("probmapsthresh2.pdf")


easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname1, res$rrcolors, mods, space="both", probmap=FALSE, obs = NULL)

easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname2, res$probcolors, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname3, res$probcolors.thresh1, mods, space="both", probmap=TRUE, obs = NULL)
easyplot(prefect = japan.prefect2 , polygons = japan.poly2 ,pdfname4, res$probcolors.thresh2, mods, space="both", probmap=TRUE, obs = NULL)

```



